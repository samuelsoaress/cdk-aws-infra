# CDK AWS Infrastructure

Infraestrutura AWS com CDK para FastAPI e Gateway.

Agora existem DOIS modos de opera√ß√£o:

1. Modo Persistente (recomendado para desenvolvimento) - inst√¢ncia EC2 √∫nica executando ambos os servi√ßos (sem ASG / ALB)
2. Modo Escal√°vel (legado / produ√ß√£o) - ASGs separados + ALB com path-based routing

## üèóÔ∏è Arquitetura

### Componentes (Modo Persistente)

- **VPC** p√∫blica simples (sem NAT)
- **EC2 √önica** (t4g.medium) rodando FastAPI (porta 8000) e Gateway (porta 3000) via docker-compose
- **Security Group** com SSH + portas 8000/3000 expostas (pode restringir conforme necess√°rio)
- **S3** para configs (opcional em dev, ainda suportado)
- **SSM** para par√¢metros / acesso Session Manager

### Componentes (Modo Escal√°vel - Legado)

- **ASGs** separados (FastAPI e Gateway)
- **ALB** p√∫blico com regras /swagger/api/* e /swagger/gw/*
- **Target Groups** com health checks
- **Instance Refresh** para deploy azul/verde

### Caracter√≠sticas de Resili√™ncia

- **Instance Refresh**: Blue/Green deployment controlado
- **Auto Recovery**: Health checks e State Manager
- **Zero Downtime**: Substitui√ß√£o controlada de inst√¢ncias
- **Persist√™ncia**: Configura√ß√µes em S3, volumes EBS opcionais

## üöÄ Quick Start

### 1. Inicializa√ß√£o

```bash
./deploy.sh init
```

### 2. Deploy Completo (modo persistente r√°pido)

```bash
./deploy.sh deploy
```

### 3. Verificar Status

```bash
./deploy.sh status
```

## üìã Comandos Dispon√≠veis

Em modo persistente N√ÉO h√° Instance Refresh nem necessidade de quick-restart; basta redeploy / atualizar c√≥digo e reiniciar containers conforme necessidade.

### Deploy Principal
```bash
./deploy.sh <command> [options]
```

#### Comandos:
- `init` - Configurar ambiente e bootstrap CDK
- `deploy` - Deploy completo (infra + configs + refresh)
- `deploy-infra [opts]` - Deploy apenas da infraestrutura
- `upload-configs` - Upload apenas das configura√ß√µes Docker
- `refresh [target]` - LEGADO (apenas modo escal√°vel)
- `status` - Verificar status (em modo persistente use a URL direta ou SSH)
- `info` - Mostrar informa√ß√µes da stack
- `destroy` - Destruir infraestrutura

#### Op√ß√µes para deploy-infra:
- `--expose-swagger-public true|false` (default: true)
- `--restrict-swagger-to-cidr CIDR` (opcional)
- `--use-eip true|false` (default: false)
- `--arch ARM_64|X86_64` (default: ARM_64)

### Exemplos

```bash
# Deploy com configura√ß√µes customizadas
./deploy.sh deploy-infra --expose-swagger-public true --arch ARM_64

# Refresh apenas do FastAPI
./deploy.sh refresh fastapi

# Refresh for√ßado (cancela refresh em andamento)
./instance-refresh.sh fastapi --force

# Upload de novas configura√ß√µes
./deploy.sh upload-configs
```

## üöÄ CI/CD com GitHub Actions

O workflow principal (`deploy.yml`) agora aceita o par√¢metro `persistent_mode` (boolean):

```
persistent_mode: true  # cria uma √∫nica inst√¢ncia dev
```

Quando `persistent_mode=true`:
- ASGs/ALB N√ÉO s√£o criados
- Um EC2 √∫nico com docker-compose sobe ambos os servi√ßos
- Outputs e par√¢metros SSM espec√≠ficos s√£o gerados:
  - /infra/cdk/dev/instance-id
  - /infra/cdk/dev/public-ip
  - DevFastApiUrl / DevGatewayUrl (Outputs CloudFormation)
  - /infra/cdk/mode/persistent = true

### Workflows Dispon√≠veis

#### 1. Deploy Principal (`deploy.yml`)
Executa automaticamente em push para `main` ou pode ser executado manualmente.

**Triggers:**
- Push para `main`/`master`
- Pull Request (apenas valida√ß√£o)
- Manual com par√¢metros customizados

**Par√¢metros de Deploy Manual:**
- `target`: infrastructure | frontend | both | configs-only | refresh-only
- `instance_refresh`: true/false (IGNORADO quando persistent_mode=true)
- `expose_swagger_public`: true/false (irrelevante em modo persistente porque n√£o h√° ALB)
- `arch`: ARM_64 | X86_64
- `persistent_mode`: true/false

**Exemplo de uso manual:**
```
GitHub Actions ‚Üí Deploy AWS Infrastructure ‚Üí Run workflow
Target: both
Instance Refresh: true
Expose Swagger Public: true
Architecture: ARM_64
```

#### 2. Manuten√ß√£o (`maintenance.yml`)
Workflow manual para opera√ß√µes de manuten√ß√£o.

**A√ß√µes dispon√≠veis:**
- `instance-refresh`: Refresh controlado das inst√¢ncias
- `upload-configs`: Re-upload das configura√ß√µes Docker
- `status-check`: Verifica√ß√£o completa de status
- `emergency-stop`: Parada de emerg√™ncia (scale down para 0)
- `emergency-start`: In√≠cio de emerg√™ncia (scale up para 1)

**Exemplo de uso:**
```
GitHub Actions ‚Üí Infrastructure Maintenance ‚Üí Run workflow
Action: instance-refresh
Target: both
Force: false
```

#### 3. Monitor de Sa√∫de (`health-monitor.yml`)
Executa automaticamente para monitorar a sa√∫de dos servi√ßos.

**Caracter√≠sticas:**
- Execu√ß√£o autom√°tica a cada 30 minutos (hor√°rio comercial)
- Health check autom√°tico dos endpoints
- Tentativa de auto-recovery em caso de falha
- Cria√ß√£o autom√°tica de issues para falhas cr√≠ticas
- Execu√ß√£o manual para verifica√ß√µes detalhadas

### Secrets Necess√°rios

Configure os seguintes secrets no GitHub:

```
AWS_ACCESS_KEY_ID
AWS_SECRET_ACCESS_KEY
AWS_REGION
```

### Estrutura de Deploy Autom√°tico

1. **Valida√ß√£o** (PRs)
   - CDK synth
   - CDK diff (se credenciais dispon√≠veis)

2. **Deploy** (Push para main)
   - Setup do ambiente
   - CDK bootstrap (se necess√°rio)
   - Deploy da infraestrutura
   - Upload de configura√ß√µes Docker
   - Instance refresh autom√°tico
   - Verifica√ß√£o de status
   - Gera√ß√£o de relat√≥rio

3. **Monitoramento** (Agendado)
   - Health check dos servi√ßos
   - Auto-recovery em caso de falha
   - Alertas automatizados

### Relat√≥rios e Summaries

Cada workflow gera relat√≥rios detalhados com:
- URLs dos servi√ßos
- Status de sa√∫de
- Par√¢metros utilizados
- A√ß√µes executadas
- Links para troubleshooting

## üîß Scripts Auxiliares

### instance-refresh.sh (LEGADO)
Mantido apenas para compatibilidade quando `persistent_mode=false`.

### upload-configs.sh
Faz upload das configura√ß√µes Docker para S3:
```bash
./upload-configs.sh
```

## üåê Endpoints de Acesso

Modo Persistente:
- **FastAPI Health**: `http://<DEV-IP>:8000/health`
- **Gateway Docs**: `http://<DEV-IP>:3000/api-docs`

Modo Escal√°vel (LEGADO):
- **FastAPI Swagger**: `http://<ALB-DNS>/swagger/api/docs`
- **Gateway Swagger**: `http://<ALB-DNS>/swagger/gw/api-docs`

## üîí Security Groups

### Internal SG (Compartilhado)
- **Outbound**: Allow all
- **Inbound**:
  - TCP 8000 (FastAPI) - entre membros do SG
  - TCP 3000 (Gateway) - entre membros do SG
  - ICMP - para ping interno
  - TCP 8000/3000 - do ALB SG

### ALB SG
- **Outbound**: Allow all
- **Inbound**:
  - TCP 80/443 - p√∫blico ou restrito por CIDR

## üíæ Persist√™ncia e Configura√ß√£o

### S3 Bucket
Armazena configura√ß√µes Docker:
```
s3://bucket-name/
‚îú‚îÄ‚îÄ fastapi/
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ gateway/
    ‚îú‚îÄ‚îÄ docker-compose.yml
    ‚îî‚îÄ‚îÄ .env
```

### UserData Idempotente
- Instala Docker e Docker Compose
- Baixa configura√ß√µes do S3
- Sobe servi√ßos automaticamente
- Configura health checks via cron

### SSM State Manager
Document para garantir que os servi√ßos Docker estejam sempre rodando.

## üèóÔ∏è Tipos de Inst√¢ncia

**Mantidos da configura√ß√£o atual:**
- **FastAPI**: `t4g.micro` (ARM64)
- **Gateway**: `t4g.medium` (ARM64)
- **AMI**: Amazon Linux 2023

## üîÑ Instance Refresh (LEGADO)

### Estrat√©gia Blue/Green
- **MinHealthyPercentage**: 0 (permite total replacement)
- **InstanceWarmup**: 300s
- **Checkpoints**: 50%, 100%
- **CheckpointDelay**: 300s

### Quando Ocorre Refresh (somente persistent_mode=false)
- Mudan√ßas no Launch Template
- Mudan√ßas na configura√ß√£o do ASG
- Execu√ß√£o manual via script

## üìä Monitoramento

### Health Checks
- **ALB**: `/docs` e `/api-docs` endpoints para health checks
- **ASG**: ELB health check + auto recovery
- **State Manager**: Execu√ß√£o peri√≥dica para auto-heal

### Logs e Debug
```bash
# Verificar logs das inst√¢ncias
aws ssm start-session --target <instance-id>

# Ver logs do Docker
sudo docker-compose logs -f

# Status dos containers
sudo docker-compose ps
```

## üîß Troubleshooting

### Problemas com CDK Synth

#### Erro: `.venv/bin/python: not found`
O projeto usa um script wrapper (`run-app.sh`) que automaticamente detecta o ambiente:
- **Local**: Usa `.venv/bin/python` se dispon√≠vel
- **CI/CD**: Usa `python3` global com depend√™ncias instaladas

Se tiver problemas:
```bash
# Testar o script diretamente
./run-app.sh

# Ou instalar depend√™ncias globalmente
pip3 install -r requirements.txt
```

### Instance Refresh Travado
```bash
# Cancelar refresh atual
./instance-refresh.sh fastapi --force
```

### Servi√ßos n√£o Respondendo
```bash
# Verificar status
./deploy.sh status

# Re-upload configs e refresh
./deploy.sh upload-configs
./deploy.sh refresh both
```

### Debug de Inst√¢ncias
```bash
# Conectar via Session Manager
aws ssm start-session --target $(aws ec2 describe-instances \
  --filters "Name=tag:aws:autoscaling:groupName,Values=<ASG-NAME>" \
  --query "Reservations[0].Instances[0].InstanceId" --output text)
```

### CI/CD Troubleshooting

#### Deploy Falha no GitHub Actions
1. Verificar secrets AWS configurados
2. Verificar permiss√µes IAM
3. Executar `cdk synth` localmente para validar

#### Health Monitor Criando Issues Desnecess√°rias
1. Ajustar thresholds no workflow
2. Verificar se os endpoints `/docs` e `/api-docs` est√£o respondendo
3. Considerar aumentar timeout dos health checks

#### Instance Refresh Travado no CI/CD
```bash
# Cancelar via GitHub Actions
GitHub Actions ‚Üí Infrastructure Maintenance ‚Üí Run workflow
Action: instance-refresh
Target: both
Force: true
```

#### Emergency Stop/Start
```bash
# Via GitHub Actions
GitHub Actions ‚Üí Infrastructure Maintenance ‚Üí Run workflow
Action: emergency-stop  # ou emergency-start
Target: both
```

#### Verificar Logs de Deploy
1. GitHub Actions ‚Üí Deploy AWS Infrastructure ‚Üí Ver √∫ltimo run
2. Expandir se√ß√µes com falhas
3. Verificar outputs de CDK e AWS CLI

## üóÇÔ∏è Estrutura de Arquivos

```
‚îú‚îÄ‚îÄ app.py                    # CDK App principal
‚îú‚îÄ‚îÄ run-app.sh               # Script wrapper para executar CDK
‚îú‚îÄ‚îÄ cdk.json                  # Configura√ß√£o CDK
‚îú‚îÄ‚îÄ requirements.txt          # Depend√™ncias Python
‚îú‚îÄ‚îÄ deploy.sh                 # Script principal de deploy
‚îú‚îÄ‚îÄ instance-refresh.sh       # Gerenciamento de Instance Refresh
‚îú‚îÄ‚îÄ upload-configs.sh         # Upload de configura√ß√µes Docker
‚îú‚îÄ‚îÄ manage-instances.sh       # (legacy)
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îú‚îÄ‚îÄ deploy.yml        # CI/CD principal
‚îÇ       ‚îú‚îÄ‚îÄ maintenance.yml   # Opera√ß√µes de manuten√ß√£o
‚îÇ       ‚îî‚îÄ‚îÄ health-monitor.yml # Monitoramento autom√°tico
‚îú‚îÄ‚îÄ cdk_aws_infra/
‚îÇ   ‚îî‚îÄ‚îÄ stacks/
‚îÇ       ‚îú‚îÄ‚îÄ infrastructure_stack.py  # Stack principal (ASG + ALB)
‚îÇ       ‚îî‚îÄ‚îÄ frontend_stack.py        # Stack do frontend (S3 + CloudFront)
‚îî‚îÄ‚îÄ cdk.out/                  # Arquivos gerados pelo CDK
```

## üéØ Objetivos Alcan√ßados

‚úÖ **Modo Dev Est√°vel**: Inst√¢ncia √∫nica n√£o sofre recria√ß√µes autom√°ticas  
‚úÖ **Altern√¢ncia F√°cil**: `-c persistent_mode=true|false` no CDK / workflow  
‚úÖ **Par√¢metros SSM Claros**: /infra/cdk/dev/* para acesso r√°pido  
‚úÖ **Still Compatible**: Arquitetura antiga preservada para produ√ß√£o  
‚úÖ **Deploy Mais R√°pido**: Sem Instance Refresh em dev  
‚úÖ **Documenta√ß√£o Atualizada**  

## üìù Notas Importantes

- **RemovalPolicy.RETAIN**: ASGs e buckets preservados em destroy
- **Sem NAT Gateway**: Economia de custos, inst√¢ncias em subnets p√∫blicas
- **Health checks configurados**: 30s interval, timeouts otimizados
- **Instance Refresh monitorado**: Scripts mostram progresso em tempo real
- **Configura√ß√µes versionadas**: S3 bucket com versionamento habilitado
